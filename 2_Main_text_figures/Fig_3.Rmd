---
title: "Nasal and gut microbiota colonization patterns and associations between delayed colonization and respiratory health (Figure 3)"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Setup 

```{r, warning=FALSE, message=FALSE}
R.version.string
library(phyloseq); packageVersion('phyloseq')
library(ggplot2); packageVersion('ggplot2')
library(cowplot); packageVersion('cowplot')
library(vegan); packageVersion('vegan')
library(tidyr); packageVersion('tidyr')
library(reshape2); packageVersion('reshape2')
library(dplyr); packageVersion('dplyr')  
library(lmPerm); packageVersion('lmPerm')
library(UpSetR); packageVersion('UpSetR')
library(ComplexHeatmap); packageVersion('ComplexHeatmap')
library(circlize); packageVersion('circlize')

source("Preprocessing/Functions.R")
```

```{r}
theme_set(theme_bw() + theme(plot.title = element_text(hjust = 0.5,face = "bold"), strip.text.x = element_text(size = 11), strip.background = element_rect(colour="white", fill="white"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), text = element_text(size=12), axis.text = element_text(color="black", size=12), legend.key.size = unit(0.5,"cm")))

cbPalette <- c("navy", "paleturquoise4",  "violetred3", "skyblue1", "goldenrod3")
```

### Microbiota Trajectory data subsets used
```{r}
Nasal_3M1Y_pa_filt <- readRDS("Data_subsets/Main_Nasal_Trajectory_Subset.rds") # Prevalence dataset

Gut_3M1Y_pa_filt <- readRDS("Data_subsets/Main_Gut_Trajectory_Subset.rds") # Prevalence dataset
```

```{r}
# splitting by timepoint for downstream analyses
N.pa.3m <- subset_samples(Nasal_3M1Y_pa_filt, Visit == "3 Months")
N.pa.1y <- subset_samples(Nasal_3M1Y_pa_filt, Visit == "1 Year")

G.pa.3m <- subset_samples(Gut_3M1Y_pa_filt, Visit == "3 Months")
G.pa.1y <- subset_samples(Gut_3M1Y_pa_filt, Visit == "1 Year")
```


# Volcano plots identifying general colonization patterns (Fig. 3A)

## Nasal - McNemar test for overall prevalence trajectories

```{r}
# input
N_taxa <- ntaxa(Nasal_3M1Y_pa_filt)
N_subj <- nsamples(Nasal_3M1Y_pa_filt)/2
TP_1 <- N.pa.3m
TP_2 <- N.pa.1y

# setup
N_3m_otu <- as.data.frame(t(as(otu_table(TP_1), "matrix")))
N_1y_otu <- as.data.frame(t(as(otu_table(TP_2), "matrix")))

N_3m_otu_sdf <- data.frame(N_3m_otu, CHILDid=sample_data(TP_1)$CHILDid)
N_1y_otu_sdf <- data.frame(N_1y_otu, CHILDid=sample_data(TP_2)$CHILDid)

## don't like how data.frame function changed the column names, changing back
colnames(N_3m_otu_sdf)[1:N_taxa] <- colnames(N_3m_otu)
colnames(N_1y_otu_sdf)[1:N_taxa] <- colnames(N_1y_otu)

# Making sure 3m and 1y dataframe are in the same order
N_3m_otu_sdf <- N_3m_otu_sdf[order(N_3m_otu_sdf$CHILDid),]
N_1y_otu_sdf <- N_1y_otu_sdf[order(N_1y_otu_sdf$CHILDid),]

identical(N_3m_otu_sdf$CHILDid, N_1y_otu_sdf$CHILDid) # good

# are in the same order in both lists, remove ids for test
N_3m_otu_sdf$CHILDid <- NULL
N_1y_otu_sdf$CHILDid <- NULL

# Removing the persistently present taxa that cannot be tested (~100% prevalence at both timepoints)
N_3m_otu_sdf$`Streptococcus sp. 40` <- NULL 
N_1y_otu_sdf$`Streptococcus sp. 40`  <- NULL
```

```{r}
# McNemar test
## list of contingency tables
Nasal_Tab_3m1y <- mapply(FUN=table, as.list(N_3m_otu_sdf),  as.list(N_1y_otu_sdf) , SIMPLIFY = FALSE, USE.NAMES = TRUE) 

## RUN
Nasal_3m1y_Mcnem_p_df <- Nasal_Tab_3m1y %>% lapply(., FUN = mcnemar.test) %>% lapply(., function(x) {x["p.value"]}) %>% bind_rows(., .id = "OTU")

Nasal_3m1y_Mcnem_p_df$p.value.BH <- p.adjust(Nasal_3m1y_Mcnem_p_df$p.value, method="BH" , n = length(Nasal_3m1y_Mcnem_p_df$p.value))

# Calculate average proportion at 3 months and 1 year
prop_3m <- taxa_sums(TP_1)/N_subj
prop_1y <- taxa_sums(TP_2)/N_subj

props <- data.frame(Nasal_3M_P=prop_3m*100, Nasal_1Y_P=prop_1y*100, Nasal_3M_SE=sqrt(prop_3m*(1-prop_3m)/N_subj), Nasal_1Y_SE=sqrt(prop_1y*(1-prop_1y)/N_subj))
props$OTU <- row.names(props)

# strep is 100 and 0 SE so no test done, automatic 100% persistent (NA p values for this one)
Nasal_3m1y_Mcnem_p_df2 <- merge(Nasal_3m1y_Mcnem_p_df, props, by="OTU", all=TRUE) 

# Calc change in prevalence
Nasal_3m1y_Mcnem_p_df2$Nasal_changeP_1Y3M <- Nasal_3m1y_Mcnem_p_df2$Nasal_1Y_P - Nasal_3m1y_Mcnem_p_df2$Nasal_3M_P 
```

Using a more strict p-value threshold in addition to an effect size cutoff to define colonizers (checked volcano plots of nasal and gut before deciding on these thresholds)
```{r, warning=FALSE}
Nasal_3m1y_Mcnem_p_df2$Colonization_pattern_final <- ifelse(Nasal_3m1y_Mcnem_p_df2$p.value.BH < 0.001 & Nasal_3m1y_Mcnem_p_df2$Nasal_changeP_1Y3M < -7, "Early",
                                                     ifelse(Nasal_3m1y_Mcnem_p_df2$p.value.BH < 0.001 & Nasal_3m1y_Mcnem_p_df2$Nasal_changeP_1Y3M >7, "Late", "Persistent"))

### most taxa colonize later, and average change in prevalence for these late colonizers is 19.5%
data_summary_V2(Nasal_3m1y_Mcnem_p_df2, varname = "Nasal_changeP_1Y3M", groupnames = "Colonization_pattern_final") 
```

Volcano plots aesthetics
```{r}
# Adding additional annotation
Nasal_3m1y_Mcnem_p_df2$Colonization_pattern_final <- factor(Nasal_3m1y_Mcnem_p_df2$Colonization_pattern_final, levels = c("Early", "Persistent", "Late"))

# labeling important/example early vs late taxa separately b/c they require different nudge_x's. 
Nasal_3m1y_Mcnem_p_df2$Label <- ifelse(Nasal_3m1y_Mcnem_p_df2$Nasal_changeP_1Y3M > 41, Nasal_3m1y_Mcnem_p_df2$OTU, "")

Nasal_3m1y_Mcnem_p_df2$Label2 <- ifelse(Nasal_3m1y_Mcnem_p_df2$Nasal_changeP_1Y3M < -19.6 | Nasal_3m1y_Mcnem_p_df2$OTU == "Staphylococcus aureus 10" | Nasal_3m1y_Mcnem_p_df2$OTU == "Streptococcus salivarius 5", Nasal_3m1y_Mcnem_p_df2$OTU, "")

# abbreviate long names and remove the "sp."
Nasal_3m1y_Mcnem_p_df2$Label2 <- gsub("Streptococcus salivarius 5", "S. salivarius 5", Nasal_3m1y_Mcnem_p_df2$Label2)
Nasal_3m1y_Mcnem_p_df2$Label2 <- gsub("Staphylococcus aureus 10", "S. aureus 10", Nasal_3m1y_Mcnem_p_df2$Label2)
Nasal_3m1y_Mcnem_p_df2$Label2 <- gsub("Staphylococcus hominis 2", "S. hominis 2", Nasal_3m1y_Mcnem_p_df2$Label2)
Nasal_3m1y_Mcnem_p_df2$Label2 <- gsub("sp\\.", "", Nasal_3m1y_Mcnem_p_df2$Label2)
Nasal_3m1y_Mcnem_p_df2$Label <- gsub("sp\\.", "", Nasal_3m1y_Mcnem_p_df2$Label)


# To make everything italic... can change label within data.frame and then use parse = TRUE or use fontface=3
Nasal_3m1y_Mcnem_p_df2$Label <- gsub("^", "italic('", Nasal_3m1y_Mcnem_p_df2$Label)
Nasal_3m1y_Mcnem_p_df2$Label <- gsub("$", "')", Nasal_3m1y_Mcnem_p_df2$Label)
```

```{r, warning=FALSE}
ann_size <- 2.8
axis_size <- 9
ax_title_s <- 10

Fig_3A_N <- ggplot(data=Nasal_3m1y_Mcnem_p_df2, aes(x=Nasal_changeP_1Y3M, y=-log10(p.value.BH), color=Colonization_pattern_final)) + 
  geom_point(size=2) + geom_hline(yintercept = -log10(0.001), color="black") + geom_vline(xintercept = 7, color="black")  + 
  geom_vline(xintercept = -7, color="black") + labs(color="Colonization", x="1 Year - 3 Month Prevalence (%)", y="-log10(FDR p-value)") + 
  ggtitle("Colonization Patterns Nasal (n=1545)") + scale_x_continuous(limits = c(-20, 52)) + 
  geom_text(aes(label=Label), nudge_x=-13, color="black", size=ann_size, parse = TRUE) +
  geom_text(aes(label=Label2), nudge_x = 8,nudge_y=5.5, color="black", size=ann_size, fontface=3) +
  theme(axis.text = element_text(size=axis_size), axis.title = element_text(size= ax_title_s), title = element_text(size=11))
Fig_3A_N 
```


## Gut - McNemar test for overall prevalence trajectories

```{r}
# input
N_taxa_G <- ntaxa(Gut_3M1Y_pa_filt)
N_subj_G <- nsamples(Gut_3M1Y_pa_filt)/2
TP_1 <- G.pa.3m
TP_2 <- G.pa.1y

# setup

# using dataset with all 3 month and 1 year gut and nasal samples for now - same infants in all datasets to reduce variation 
G_3m_otu <- as.data.frame(t(as(otu_table(TP_1), "matrix")))
G_1y_otu <- as.data.frame(t(as(otu_table(TP_2), "matrix")))

G_3m_otu_sdf <- data.frame(G_3m_otu, CHILDid=sample_data(TP_1)$CHILDid)
G_1y_otu_sdf <- data.frame(G_1y_otu, CHILDid=sample_data(TP_2)$CHILDid)

## don't like how data.frame function changed the column names, changing back
colnames(G_3m_otu_sdf)[1:N_taxa_G] <- colnames(G_3m_otu)
colnames(G_1y_otu_sdf)[1:N_taxa_G] <- colnames(G_1y_otu)


G_3m_otu_sdf <- G_3m_otu_sdf[order(G_3m_otu_sdf$CHILDid),]
G_1y_otu_sdf <- G_1y_otu_sdf[order(G_1y_otu_sdf$CHILDid),]

identical(G_3m_otu_sdf$CHILDid, G_1y_otu_sdf$CHILDid) # good

# are in the same order in both lists
G_3m_otu_sdf$CHILDid <- NULL
G_1y_otu_sdf$CHILDid <- NULL
```

```{r}
# McNemar test

## list of contingency tables
Gut_Tab_3m1y <- mapply(FUN=table, as.list(G_3m_otu_sdf),  as.list(G_1y_otu_sdf), SIMPLIFY = FALSE, USE.NAMES = TRUE) 

## RUN
Gut_3m1y_Mcnem_p_df <- Gut_Tab_3m1y %>% lapply(., FUN = mcnemar.test) %>% lapply(., function(x) {x["p.value"]}) %>% bind_rows(., .id = "OTU")

Gut_3m1y_Mcnem_p_df$p.value.BH <- p.adjust(Gut_3m1y_Mcnem_p_df$p.value, method="BH" , n = length(Gut_3m1y_Mcnem_p_df$p.value))

# Calculate average proporition at 3 months and 1 year
prop_3m <- taxa_sums(TP_1)/N_subj_G
prop_1y <- taxa_sums(TP_2)/N_subj_G

props <- data.frame(Gut_3M_P=prop_3m*100, Gut_1Y_P=prop_1y*100, Gut_3M_SE=sqrt(prop_3m*(1-prop_3m)/N_subj_G), Gut_1Y_SE=sqrt(prop_1y*(1-prop_1y)/N_subj_G))
props$OTU <- row.names(props)

# strep is 100 and 0 SE so no test done, automatic 100% persistent (NA p values for this one)
Gut_3m1y_Mcnem_p_df2 <- merge(Gut_3m1y_Mcnem_p_df, props, by="OTU", all=TRUE) 

# Calc change in prevalence
Gut_3m1y_Mcnem_p_df2$Gut_changeP_1Y3M <- Gut_3m1y_Mcnem_p_df2$Gut_1Y_P - Gut_3m1y_Mcnem_p_df2$Gut_3M_P 
```

The Mcnemar test appears to be very sensitive. Use a more strict p-value threshold in addition to an effect size cutoff to define Late and Early colonizers as oppose to persistent (no change) colonizers.
```{r}
Gut_3m1y_Mcnem_p_df2$Colonization_pattern_final <- ifelse(Gut_3m1y_Mcnem_p_df2$p.value.BH < 0.001 & Gut_3m1y_Mcnem_p_df2$Gut_changeP_1Y3M < -7, "Early",
                                                          ifelse(Gut_3m1y_Mcnem_p_df2$p.value.BH < 0.001 & Gut_3m1y_Mcnem_p_df2$Gut_changeP_1Y3M >7, "Late", "Persistent"))

### most taxa colonize later (65), and average change in prevalence for these late colonizers is 15%
data_summary(Gut_3m1y_Mcnem_p_df2, varname = "Gut_changeP_1Y3M", groupnames = "Colonization_pattern_final") 
```

Volcano plots aesthetics 
```{r}
# Adding additional annotation
Gut_3m1y_Mcnem_p_df2$Colonization_pattern_final <- factor(Gut_3m1y_Mcnem_p_df2$Colonization_pattern_final, levels = c("Early", "Persistent", "Late"))

# labeling important/example early vs late taxa separately b/c they require differnt nudge_x's. 
Gut_3m1y_Mcnem_p_df2$Label <- ifelse(Gut_3m1y_Mcnem_p_df2$Gut_changeP_1Y3M > 30.5 | Gut_3m1y_Mcnem_p_df2$OTU == "Flavonifractor sp.", Gut_3m1y_Mcnem_p_df2$OTU, "")
Gut_3m1y_Mcnem_p_df2$Label2 <- ifelse(Gut_3m1y_Mcnem_p_df2$Gut_changeP_1Y3M < -18, Gut_3m1y_Mcnem_p_df2$OTU, "")

# abbreviate long names and remove the "sp."
Gut_3m1y_Mcnem_p_df2$Label2 <- gsub("Enterococcus faecalis 1", "E. faecalis 1", Gut_3m1y_Mcnem_p_df2$Label2)
Gut_3m1y_Mcnem_p_df2$Label2 <- gsub("sp\\.", "", Gut_3m1y_Mcnem_p_df2$Label2)
Gut_3m1y_Mcnem_p_df2$Label <- gsub("sp\\.", "", Gut_3m1y_Mcnem_p_df2$Label)
```

```{r, warning=FALSE}
ann_size <- 2.8
axis_size <- 9
ax_title_s <- 10

Fig_3A_G <- ggplot(data=Gut_3m1y_Mcnem_p_df2, aes(x=Gut_changeP_1Y3M, y=-log10(p.value.BH), color=Colonization_pattern_final)) + 
  geom_point(size=2) + geom_hline(yintercept = -log10(0.001), color="black") + geom_vline(xintercept = 7, color="black")  + 
  geom_vline(xintercept = -7, color="black") + labs(color="Colonization", x="1 Year - 3 Month Prevalence (%)", y="-log10(FDR p-value)") + 
  ggtitle("Colonization Patterns Gut (n=555)")+ scale_x_continuous(limits = c(-23.5, 52)) + 
  geom_text(aes(label=Label),nudge_y=0.5, nudge_x=11.5, color="black", size=ann_size, fontface=3) + 
  geom_text(aes(label=Label2), nudge_x = 10,nudge_y=0.8, color="black", size=ann_size, fontface=3) +
  theme(axis.text = element_text(size=axis_size), axis.title =element_text(size=ax_title_s),  title = element_text(size=11))
Fig_3A_G
```

```{r, warning=FALSE, include=FALSE}
# save results for Fig 3A
tiff(file = "Figures/Fig_3A_Nasal_Volcano_Overall.tiff", width = 1800, height = 1000, units = "px", res = 300) 
Fig_3A_N
dev.off()

tiff(file = "figures/Fig_3A_Gut_Volcano_Overall.tiff", width = 1800, height = 1000, units = "px", res = 300) 
Fig_3A_G
dev.off()

# Table S3. Change in prevalence from 3 months to 1 year for 170 Nasal taxa and 115 gut taxa and McNemar test results 
write.csv(Nasal_3m1y_Mcnem_p_df2, file="Output/TableS3_Nasal_McNemar_res_Volcano.csv")
write.csv(Gut_3m1y_Mcnem_p_df2, file="Output/TableS3_Nasal_McNemar_res_Volcano.csv")
```


# Prevalence Trajectory Coordinate System & Permutation tests - Comparing Prevalence Trajectories Between Groups (Fig. 3B-D)

## Nasal - Prevalence Trajectory derived variables, creation of a prevalence trajectory feature table
To simplify making of prevalence trajectory scatter plots, first make the 'difference in prevalence' results for every pair of samples for each infant (1Y - 3M, e.g. 0 - 1 = -1; 1 - 0 = 1) - so a "-1" means it's present at 3 months but not 1 year, 1 means 1 year but not 3m and 0 means no change.
```{r} 
## extract otu table and use Participant IDs as row.names instead - will match b/t datasets
N_3m_otu <- data.frame(as.data.frame(t(as(otu_table(N.pa.3m), "matrix"))), row.names=sample_data(N.pa.3m)$CHILDid)
N_1y_otu <- data.frame(as.data.frame(t(as(otu_table(N.pa.1y), "matrix"))), row.names=sample_data(N.pa.1y)$CHILDid)

N_3m_otu <- N_3m_otu[order(row.names(N_3m_otu)),]
N_1y_otu <- N_1y_otu[order(row.names(N_1y_otu)),]

## Checking - colnames and Childid's are in the same order? Yes - good - can move forward
identical(colnames(N_3m_otu), colnames(N_1y_otu))
identical(row.names(N_1y_otu), row.names(N_3m_otu))

## 1 Year minus 3 Month Prevalence For each Taxa
change_3m1y_pa <- N_1y_otu - N_3m_otu # -1 = present at 3m not 1y, 1= present at 1y not 3m, 0=either present at both or neither timpoint
dim(change_3m1y_pa) # Same order as original physeq obj

# Sample data to merge with dataset
sdf_toAdd <- sample_data(N.pa.1y)[order(sample_data(N.pa.1y)$CHILDid),]
sdf_3m <- sample_data(N.pa.3m)[order(sample_data(N.pa.3m)$CHILDid),]
## check that it's in the same order as change_3m1y_pa
identical(row.names(change_3m1y_pa), sdf_toAdd$CHILDid) 
identical(row.names(change_3m1y_pa), sdf_3m$CHILDid) 

### same order so just merge data with sample metadata using data.frame
change_3m1y_pa_sdf <- data.frame(change_3m1y_pa, sdf_toAdd, RE_virus_3m = sdf_3m$RE_Virus) # Using 1 year sdf for variables (will be same for 3m and 1y for almost all) - but also adding RE virus at 3 months as "RE_virus_3m". Note that "RE_Virus" is the RE virus at 1 year.

N_taxa <- ncol(change_3m1y_pa) # number of taxa, to use in downstream code
N_subj <- nrow(change_3m1y_pa) # number of subjects, to use in downstream code
```
Objects used for Nasal trajectory plots: change_3m1y_pa_sdf, Nasal_3M1Y_pa_filt, N_taxa, N_subj 

## Gut - Prevalence Trajectory derived variables, creation of a prevalence trajectory feature table
To simplify making of prevalence trajectory scatter plots, first make the 'difference in prevalence' results for every pair of samples for each infant (1Y - 3M, e.g. 0 - 1 = -1; 1 - 0 = 1) - so a "-1" means it's present at 3 months but not 1 year, 1 means 1 year but not 3m and 0 means no change.
```{r} 
## extract otu table and use Participant IDs as row.names instead - will match b/t datasets
G_3m_otu <- data.frame(as.data.frame(t(as(otu_table(G.pa.3m), "matrix"))), row.names=sample_data(G.pa.3m)$CHILDid)
G_1y_otu <- data.frame(as.data.frame(t(as(otu_table(G.pa.1y), "matrix"))), row.names=sample_data(G.pa.1y)$CHILDid)

G_3m_otu <- G_3m_otu[order(row.names(G_3m_otu)),]
G_1y_otu <- G_1y_otu[order(row.names(G_1y_otu)),]

## Checking - colnames and Childid's are in the same order? Yes - good - can move forward
identical(colnames(G_3m_otu), colnames(G_1y_otu))
identical(row.names(G_3m_otu), row.names(G_1y_otu))

## 1 Year minus 3 Month Prevalence For each Taxa
change_3m1y_pa_G <- G_1y_otu - G_3m_otu # -1 = present at 3m not 1y, 1= present at 1y not 3m, 0=either present at both or neither timpoint
dim(change_3m1y_pa_G) # Same order as original physeq obj

sdf_toAdd <- sample_data(G.pa.1y)[order(sample_data(G.pa.1y)$CHILDid),]
sdf_3m <- sample_data(G.pa.3m)[order(sample_data(G.pa.3m)$CHILDid),]
## check that it's in the same order as change_3m1y_pa
identical(row.names(change_3m1y_pa_G), sdf_toAdd$CHILDid) # order matches
identical(row.names(change_3m1y_pa_G), sdf_3m$CHILDid) # order matches

### same order so just merge data with sample metadata using data.frame
change_3m1y_pa_G_sdf <- data.frame(change_3m1y_pa_G, sdf_toAdd, RE_virus_3m = sdf_3m$RE_Virus) # Using 1 year sdf for variables but also adding RE virus at 3 months as "RE_virus_3m". Note that "RE_Virus" is the RE virus at 1 year

N_taxa_G <- ncol(change_3m1y_pa_G) # number of taxa, to use in downstream code
N_subj_G <- nrow(change_3m1y_pa_G) # number of subjects, to use in downstream code
```
Objects used for gut trajectory plots: change_3m1y_pa_G_sdf, Gut_3M1Y_pa_filt, N_taxa_G, N_subj_G 

## Save prevalence trajectory feature tables for later use (in mediation analysis, Fig. 6)
```{r}
## don't save with metadata - just save new derived data with CHILDid's as rownames: change_3m1y_pa, change_3m1y_pa_G; 
### merge before saving, but first differentiate nasal vs gut trajectory features by prepending N or G
colnames(change_3m1y_pa) <- gsub("^", "N_", colnames(change_3m1y_pa))
colnames(change_3m1y_pa_G) <- gsub("^", "G_", colnames(change_3m1y_pa_G))

change_3m1y_pa_all <- merge(change_3m1y_pa, change_3m1y_pa_G, by="row.names", all=TRUE)
row.names(change_3m1y_pa_all) <- change_3m1y_pa_all$Row.names
change_3m1y_pa_all$Row.names <- NULL
dim(change_3m1y_pa_all)
write.csv(change_3m1y_pa_all, file="Output/Prevalence_Trajectory_Features_N171_G172.csv") # The first 171 columns are nasal taxa, 172 to end of df is gut
```

```{r} 
# setup for plots
## for plot annotations:
Main_phyla <- c('Proteobacteria','Firmicutes', "Actinobacteria", "Bacteroidetes")
```

## Nasal - Asthma at 3 years - Figure 3C
```{r} 
X <- subset(change_3m1y_pa_sdf, asthma_3y == "Probable")
Y <- subset(change_3m1y_pa_sdf, asthma_3y == "No")

# Make data.frame of prevalence like before BUT keeping as proprotions instead of Percentages for now
df.pa.nasal.ast <- data.frame(X_P_Change=colSums(X[1:N_taxa])*100/dim(X)[1],Y_P_Change=colSums(Y[1:N_taxa])*100/dim(Y)[1], taxonomy=as(tax_table(Nasal_3M1Y_pa_filt), "matrix"), prevalence=taxa_sums(Nasal_3M1Y_pa_filt)*100/(N_subj*2)) 

# difference in change
df.pa.nasal.ast$pa.change.diff <- df.pa.nasal.ast$Y_P_Change - df.pa.nasal.ast$X_P_Change
```
Aesthetic things
```{r} 
# Plot by major phylum & annotate signif taxa
df.pa.nasal.ast$Phylum <- ifelse(df.pa.nasal.ast$taxonomy.Phylum %in% Main_phyla, df.pa.nasal.ast$taxonomy.Phylum, "Other")
#Reorder the phyla 
df.pa.nasal.ast$Phylum = factor(df.pa.nasal.ast$Phylum, levels=c(Main_phyla, "Other"))
```
Plot Change in Prevalence
```{r} 
x_lab <- paste("Asthma (n=", nrow(X), ")\n1 Year - 3 Month Prevalence (%)", sep="")
y_lab <- paste("No Asthma (n=", nrow(Y), ")\n1 Year - 3 Month Prevalence (%)", sep="")

Fig_3C_N <- ggplot() + 
  geom_point(data=df.pa.nasal.ast, aes(x=X_P_Change, y=Y_P_Change, color=Phylum, size=prevalence), alpha=0.75) + 
  xlab(x_lab) + ylab(y_lab) + 
  scale_color_manual(values = cbPalette) +
  scale_y_continuous(limits=c(-30,60), expand = c(0,0))+
  scale_x_continuous(limits=c(-30,60), expand = c(0,0))+
  annotate("segment", x = -30, xend = 60, y = -30, yend = 60, colour = "red", size=0.5) + ggtitle("Nasal")
Fig_3C_N
```
Median change in prevalence of an OTU in asthma and non-asthma infants
```{r} 
# Asthma
summary(df.pa.nasal.ast$X_P_Change)

# No Asthma
summary(df.pa.nasal.ast$Y_P_Change)
```

### Permutation test for Prevalence Trajectory analysis - Showing for Nasal, Asthma at 3 years only (See Permutation_Tests_PrevTrajectories directory for others)
This is how the test is run for all comparisons 
```{r} 
# Permutation test, Nasal Asthma 3y
X_df <- df.pa.nasal.ast

Group_A <- X_df$X_P_Change
names(Group_A) <- rep("asthma", length(Group_A))

Group_B <- X_df$Y_P_Change
names(Group_B) <- rep("No_asthma", length(Group_B))

original_wilcox <- wilcox.test(Group_A, Group_B, paired = T) # p<0.001
boxplot(Group_A, Group_B)

shuff_wilcox_p_val <- c()
diff_list <- list()


set.seed(9999)

it_num <- 1000

for(it in 1:it_num){
  
  change_3m1y_pa_sdf_shuff <- change_3m1y_pa_sdf
  
  ##Permuting the labels
  idx_shuff <- sample(c(1:length(change_3m1y_pa_sdf_shuff$asthma_3y)))
  shuff_labels <- change_3m1y_pa_sdf_shuff$asthma_3y[idx_shuff]
  
  change_3m1y_pa_sdf_shuff$asthma_3y <- shuff_labels
  
  change_pa_asthma <- subset(change_3m1y_pa_sdf_shuff, asthma_3y == "Probable")
  change_pa_Noasthma <- subset(change_3m1y_pa_sdf_shuff, asthma_3y == "No")
  
  # Make data.frame of prevalence 
  df.pa.nasal.ast_shuff <- data.frame(X_P_Change=colSums(change_pa_asthma[1:N_taxa])*100/dim(change_pa_asthma)[1],
                                      Y_P_Change=colSums(change_pa_Noasthma[1:N_taxa])*100/dim(change_pa_Noasthma)[1]) 
  
  Group_A_shuff <- df.pa.nasal.ast_shuff$X_P_Change
  names(Group_A_shuff) <- rep("asthma", length(Group_A))
  
  Group_B_shuff <- df.pa.nasal.ast_shuff$Y_P_Change
  names(Group_B_shuff) <- rep("No_asthma", length(Group_B_shuff))
  
  shuff_wilcox <- wilcox.test(Group_A_shuff, Group_B_shuff, paired = T) 
  shuff_wilcox_p_val[it] <- shuff_wilcox$p.value
  
  diff_list[[it]] <- df.pa.nasal.ast_shuff$X_P_Change - df.pa.nasal.ast_shuff$Y_P_Change
}

length(which(shuff_wilcox_p_val < original_wilcox$p.value))/it_num # 0.025

p_val_permut <- c()
for(k in 1:dim(X_df)[1]){
  
  null_dist <- c()
  for(j in 1:length(diff_list)){
    
    null_dist[j] = diff_list[[j]][k]
    
  }

    real_test_stat <- c(X_df$X_P_Change - X_df$Y_P_Change)[k]
  
  p_val_permut[k] <- length(which(null_dist > real_test_stat))/it 
  
}

names(p_val_permut) <- rownames(X_df)
#sort(1- p_val_permut)  

Res_per_taxa_ast_N <- data.frame(X_df[,c(1:2)], X_df$X_P_Change - X_df$Y_P_Change, 1- p_val_permut, p_val_permut)
names(Res_per_taxa_ast_N) <- c("pa.Ast", "pa.No.Ast", "original_effect_diff", "p_value", "p_value_2")
```

Test output
```{r} 
# Res_per_taxa_ast_N - p-value assigned to each taxa; p_value = later in healthy; p_value_2 = earlier in healthy
original_wilcox # Overall significance test for nasal, asthma at 3 years test
```


## Gut - Asthma at 3 years - Figure 3C
```{r} 
X <- subset(change_3m1y_pa_G_sdf, asthma_3y == "Probable")
Y <- subset(change_3m1y_pa_G_sdf, asthma_3y == "No")

# Make data.frame of prevalence like before BUT keeping as proprotions instead of Percentages for now
df.pa.gut.ast <- data.frame(X_P_Change=colSums(X[1:N_taxa_G])*100/dim(X)[1],Y_P_Change=colSums(Y[1:N_taxa_G])*100/dim(Y)[1], taxonomy=as(tax_table(Gut_3M1Y_pa_filt), "matrix"), prevalence=taxa_sums(Gut_3M1Y_pa_filt)*100/(N_subj_G*2)) 

# difference in change
df.pa.gut.ast$pa.change.diff <- df.pa.gut.ast$Y_P_Change - df.pa.gut.ast$X_P_Change
```
Aesthetic things, not important
```{r} 
# Plot by major phylum & annotate signif taxa
df.pa.gut.ast$Phylum <- ifelse(df.pa.gut.ast$taxonomy.Phylum %in% Main_phyla, df.pa.gut.ast$taxonomy.Phylum, "Other")
#Reorder the phyla 
df.pa.gut.ast$Phylum = factor(df.pa.gut.ast$Phylum, levels=c(Main_phyla, "Other"))
```
Plot Change in Prevalence 
```{r} 
x_lab <- paste("Asthma (n=", nrow(X), ")\n1 Year - 3 Month Prevalence (%)", sep="")
y_lab <- paste("No Asthma (n=", nrow(Y), ")\n1 Year - 3 Month Prevalence (%)", sep="")

Fig_3C_G <- ggplot() + 
  geom_point(data=df.pa.gut.ast, aes(x=X_P_Change, y=Y_P_Change, color=Phylum, size=prevalence), alpha=0.75) + 
  xlab(x_lab) + ylab(y_lab) + 
  scale_color_manual(values = cbPalette) +
  scale_y_continuous(limits=c(-30,60), expand = c(0,0))+
  scale_x_continuous(limits=c(-30,60), expand = c(0,0))+
  annotate("segment", x = -30, xend = 60, y = -30, yend = 60, colour = "red", size=0.25) + ggtitle("Gut")
Fig_3C_G
```
Median change in prevalence of an OTU in BF and non-BF infants
```{r} 
# Asthma
summary(df.pa.gut.ast$X_P_Change)

# No Asthma
summary(df.pa.gut.ast$Y_P_Change)
```

**Permutation test for Prevalence Trajectory analysis - See Permutation_Tests_PrevTrajectories directory for source code**
```{r} 
source("Permutation_Tests_PrevTrajectories/02_Asthma3Y_Gut.R")

# Test output
# Res_per_taxa_ast_G - p-value assigned to each taxa; p_value = later in healthy; p_value_2 = earlier in healthy
original_wilcox_ast_G # Overall significance test
```


### Extra Prevalence Trajectory analyses (Not shown but used for Figure 3D)
```{r} 
# creating wheeze trajectory /atopy at 3 years combination variable

## Nasal
change_3m1y_pa_sdf$Wheeze_atopy_Traj <- ifelse(!is.na(change_3m1y_pa_sdf$WheezeTraj) & !is.na(change_3m1y_pa_sdf$atopy3y), paste(change_3m1y_pa_sdf$WheezeTraj, change_3m1y_pa_sdf$atopy3y, sep = ", Atopy "), NA) 

## Gut
change_3m1y_pa_G_sdf$Wheeze_atopy_Traj <- ifelse(!is.na(change_3m1y_pa_G_sdf$WheezeTraj) & !is.na(change_3m1y_pa_G_sdf$atopy3y), paste(change_3m1y_pa_G_sdf$WheezeTraj, change_3m1y_pa_G_sdf$atopy3y, sep = ", Atopy "), NA) # Using Atopy at 3Y b/c had better luck with that & b/c asthma_3y is the main asthma variable used. 

# Focusing on:  "Persistent, Atopy No"; "Never/infrequent, Atopy Yes"; "Never/infrequent, Atopy No"
```

#### Nasal, Persistent Wheeze without Atopy at 3 years vs. no Wheeze or Atopy 
```{r} 
X <- subset(change_3m1y_pa_sdf, Wheeze_atopy_Traj == "Persistent, Atopy No")
Y <- subset(change_3m1y_pa_sdf, Wheeze_atopy_Traj == "Never/infrequent, Atopy No")

# Make data.frame of prevalence like before BUT keeping as proprotions instead of Percentages for now
df.pa.nasal.Whz.atopy <- data.frame(X_P_Change=colSums(X[1:N_taxa])*100/dim(X)[1],Y_P_Change=colSums(Y[1:N_taxa])*100/dim(Y)[1], taxonomy=as(tax_table(Nasal_3M1Y_pa_filt), "matrix"), prevalence=taxa_sums(Nasal_3M1Y_pa_filt)*100/(N_subj*2)) 

# difference in change
df.pa.nasal.Whz.atopy$pa.change.diff <- df.pa.nasal.Whz.atopy$Y_P_Change - df.pa.nasal.Whz.atopy$X_P_Change
```
- Aesthetic things
```{r} 
## Plot by major phylum & annotate signif taxa
df.pa.nasal.Whz.atopy$Phylum <- ifelse(df.pa.nasal.Whz.atopy$taxonomy.Phylum %in% Main_phyla, df.pa.nasal.Whz.atopy$taxonomy.Phylum, "Other")
#Reorder the phyla 
df.pa.nasal.Whz.atopy$Phylum = factor(df.pa.nasal.Whz.atopy$Phylum, levels=c(Main_phyla, "Other"))
```
- Plot Change in Prevalence 
```{r} 
x_lab <- paste("Wheeze, no Atopy (n=", nrow(X), ")\n1 Year - 3 Month Prevalence (%)", sep="")
y_lab <- paste("No Wheeze, no Atopy (n=", nrow(Y), ")\n1 Year - 3 Month Prevalence (%)", sep="")

Fig_Ext_N_Wheeze <- ggplot() + 
  geom_point(data=df.pa.nasal.Whz.atopy, aes(x=X_P_Change, y=Y_P_Change, color=Phylum, size=prevalence), alpha=0.75) + 
  xlab(x_lab) + ylab(y_lab) + 
  scale_color_manual(values = cbPalette) +
  scale_y_continuous(limits=c(-37,60.1), expand = c(0,0))+
  scale_x_continuous(limits=c(-37,60.1), expand = c(0,0))+
  annotate("segment", x = -37, xend = 60, y = -30, yend = 60, colour = "red", size=0.5) + ggtitle("Nasal")
Fig_Ext_N_Wheeze
```

**Permutation test for Prevalence Trajectory analysis - See Permutation_Tests_PrevTrajectories directory for source code**
```{r} 
source("Permutation_Tests_PrevTrajectories/09_Wheeze_Nasal.R")

# Test output
# Res_per_taxa_wheeze_N - p-value assigned to each taxa; p_value = later in healthy; p_value_2 = earlier in healthy
original_wilcox_wheeze_N # Overall significance test
```


#### Gut, Persistent Wheeze without Atopy at 3 years vs. no Wheeze or Atopy (Not shown but used for Figure 3D)
```{r} 
X <- subset(change_3m1y_pa_G_sdf, Wheeze_atopy_Traj == "Persistent, Atopy No")
Y <- subset(change_3m1y_pa_G_sdf, Wheeze_atopy_Traj == "Never/infrequent, Atopy No")

# Make data.frame of prevalence like before BUT keeping as proprotions instead of Percentages for now
df.pa.gut.Whz.atopy <- data.frame(X_P_Change=colSums(X[1:N_taxa_G])*100/dim(X)[1],Y_P_Change=colSums(Y[1:N_taxa_G])*100/dim(Y)[1], taxonomy=as(tax_table(Gut_3M1Y_pa_filt), "matrix"), prevalence=taxa_sums(Gut_3M1Y_pa_filt)*100/(N_subj_G*2)) 

# difference in change
df.pa.gut.Whz.atopy$pa.change.diff <- df.pa.gut.Whz.atopy$Y_P_Change - df.pa.gut.Whz.atopy$X_P_Change
```
- Aesthetic things
```{r} 
## Plot by major phylum & annotate signif taxa
df.pa.gut.Whz.atopy$Phylum <- ifelse(df.pa.gut.Whz.atopy$taxonomy.Phylum %in% Main_phyla, df.pa.gut.Whz.atopy$taxonomy.Phylum, "Other")
#Reorder the phyla 
df.pa.gut.Whz.atopy$Phylum = factor(df.pa.gut.Whz.atopy$Phylum, levels=c(Main_phyla, "Other"))
```
- Plot Change in Prevalence 
```{r} 
x_lab <- paste("Wheeze, no Atopy (n=", nrow(X), ")\n1 Year - 3 Month Prevalence (%)", sep="")
y_lab <- paste("No Wheeze, no Atopy (n=", nrow(Y), ")\n1 Year - 3 Month Prevalence (%)", sep="")

Fig_Ext_G_Wheeze <- ggplot() + 
  geom_point(data=df.pa.gut.Whz.atopy, aes(x=X_P_Change, y=Y_P_Change, color=Phylum, size=prevalence), alpha=0.75) + 
  xlab(x_lab) + ylab(y_lab) + 
  scale_color_manual(values = cbPalette) +
  scale_y_continuous(limits=c(-37,60.1), expand = c(0,0))+
  scale_x_continuous(limits=c(-37,60.1), expand = c(0,0))+
  annotate("segment", x = -37, xend = 60, y = -30, yend = 60, colour = "red", size=0.5) + ggtitle("Gut")
Fig_Ext_G_Wheeze
```

**Permutation test for Prevalence Trajectory analysis - See Permutation_Tests_PrevTrajectories directory for source code**
```{r} 
source("Permutation_Tests_PrevTrajectories/10_Wheeze_Gut.R")

# Test output
# Res_per_taxa_wheeze_G - p-value assigned to each taxa; p_value = later in healthy; p_value_2 = earlier in healthy
original_wilcox_wheeze_G # Overall significance test
```

#### Nasal, Atopy at 3 years without Persistent Wheeze vs. no Atopy or Wheeze (Not shown but used for Figure 3D)
```{r} 
X <- subset(change_3m1y_pa_sdf, Wheeze_atopy_Traj == "Never/infrequent, Atopy Yes")
Y <- subset(change_3m1y_pa_sdf, Wheeze_atopy_Traj == "Never/infrequent, Atopy No")

# Make data.frame of prevalence like before BUT keeping as proprotions instead of Percentages for now
df.pa.nasal.NoWhz.atopy <- data.frame(X_P_Change=colSums(X[1:N_taxa])*100/dim(X)[1],Y_P_Change=colSums(Y[1:N_taxa])*100/dim(Y)[1], taxonomy=as(tax_table(Nasal_3M1Y_pa_filt), "matrix"), prevalence=taxa_sums(Nasal_3M1Y_pa_filt)*100/(N_subj*2)) 

# difference in change
df.pa.nasal.NoWhz.atopy$pa.change.diff <- df.pa.nasal.NoWhz.atopy$Y_P_Change - df.pa.nasal.NoWhz.atopy$X_P_Change
```
- Aesthetic things
```{r} 
## Plot by major phylum & annotate signif taxa
df.pa.nasal.NoWhz.atopy$Phylum <- ifelse(df.pa.nasal.NoWhz.atopy$taxonomy.Phylum %in% Main_phyla, df.pa.nasal.NoWhz.atopy$taxonomy.Phylum, "Other")
#Reorder the phyla 
df.pa.nasal.NoWhz.atopy$Phylum = factor(df.pa.nasal.NoWhz.atopy$Phylum, levels=c(Main_phyla, "Other"))
```
- Plot Change in Prevalence 
```{r} 
x_lab <- paste("Atopy, no Wheeze (n=", nrow(X), ")\n1 Year - 3 Month Prevalence (%)", sep="")
y_lab <- paste("No Atopy, no Wheeze (n=", nrow(Y), ")\n1 Year - 3 Month Prevalence (%)", sep="")

Fig_Ext_N_Atopy <- ggplot() + 
  geom_point(data=df.pa.nasal.NoWhz.atopy, aes(x=X_P_Change, y=Y_P_Change, color=Phylum, size=prevalence), alpha=0.75) + 
  xlab(x_lab) + 
  ylab(y_lab) + 
  scale_color_manual(values = cbPalette) +
  scale_y_continuous(limits=c(-37,60.1), expand = c(0,0))+
  scale_x_continuous(limits=c(-37,60.1), expand = c(0,0))+
  annotate("segment", x = -37, xend = 60, y = -37, yend = 60, colour = "red", size=0.5) + ggtitle("Nasal")
Fig_Ext_N_Atopy
```

**Permutation test for Prevalence Trajectory analysis - See Permutation_Tests_PrevTrajectories directory for source code**
```{r} 
source("Permutation_Tests_PrevTrajectories/11_Atopy_Nasal.R")

# Test output
# Res_per_taxa_atopy_N - p-value assigned to each taxa; p_value = later in healthy; p_value_2 = earlier in healthy
original_wilcox_atopy_N # Overall significance test
```


#### Gut, Atopy at 3 years without Persistent Wheeze vs. no Atopy or Wheeze (Not shown but used for Figure 3D)
```{r} 
X <- subset(change_3m1y_pa_G_sdf, Wheeze_atopy_Traj == "Never/infrequent, Atopy Yes")
Y <- subset(change_3m1y_pa_G_sdf, Wheeze_atopy_Traj == "Never/infrequent, Atopy No")

# Make data.frame of prevalence like before BUT keeping as proprotions instead of Percentages for now
df.pa.gut.NoWhz.atopy <- data.frame(X_P_Change=colSums(X[1:N_taxa_G])*100/dim(X)[1],Y_P_Change=colSums(Y[1:N_taxa_G])*100/dim(Y)[1], taxonomy=as(tax_table(Gut_3M1Y_pa_filt), "matrix"), prevalence=taxa_sums(Gut_3M1Y_pa_filt)*100/(N_subj_G*2)) 

# difference in change
df.pa.gut.NoWhz.atopy$pa.change.diff <- df.pa.gut.NoWhz.atopy$Y_P_Change - df.pa.gut.NoWhz.atopy$X_P_Change
```
- Aesthetic things
```{r} 
## Plot by major phylum & annotate signif taxa
df.pa.gut.NoWhz.atopy$Phylum <- ifelse(df.pa.gut.NoWhz.atopy$taxonomy.Phylum %in% Main_phyla, df.pa.gut.NoWhz.atopy$taxonomy.Phylum, "Other")
#Reorder the phyla 
df.pa.gut.NoWhz.atopy$Phylum = factor(df.pa.gut.NoWhz.atopy$Phylum, levels=c(Main_phyla, "Other"))
```
- Plot Change in Prevalence 
```{r} 
x_lab <- paste("Atopy, no Wheeze (n=", nrow(X), ")\n1 Year - 3 Month Prevalence (%)", sep="")
y_lab <- paste("No Atopy, no Wheeze (n=", nrow(Y), ")\n1 Year - 3 Month Prevalence (%)", sep="")

Fig_Ext_G_Atopy <- ggplot() + 
  geom_point(data=df.pa.gut.NoWhz.atopy, aes(x=X_P_Change, y=Y_P_Change, color=Phylum, size=prevalence), alpha=0.75) + 
  xlab(x_lab) + ylab(y_lab) + 
  scale_color_manual(values = cbPalette) +
  scale_y_continuous(limits=c(-37,60.1), expand = c(0,0))+
  scale_x_continuous(limits=c(-37,60.1), expand = c(0,0))+
  annotate("segment", x = -37, xend = 60, y = -30, yend = 60, colour = "red", size=0.5) + ggtitle("Gut")
Fig_Ext_G_Atopy
```

**Permutation test for Prevalence Trajectory analysis - See Permutation_Tests_PrevTrajectories directory for source code**
```{r} 
source("Permutation_Tests_PrevTrajectories/12_Atopy_Gut.R")

# Test output
# Res_per_taxa_atopy_G - p-value assigned to each taxa; p_value = later in healthy; p_value_2 = earlier in healthy
original_wilcox_atopy_G # Overall significance test
```


#### Nasal, Colds 0-3 months (Not shown but used for Figure 3D)
```{r} 
X <- subset(change_3m1y_pa_sdf, colds_0to3m == "Yes")
Y <- subset(change_3m1y_pa_sdf, colds_0to3m == "No")

# Make data.frame of prevalence like before BUT keeping as proprotions instead of Percentages for now
df.pa.nasal.C1 <- data.frame(X_P_Change=colSums(X[1:N_taxa])*100/dim(X)[1],Y_P_Change=colSums(Y[1:N_taxa])*100/dim(Y)[1], taxonomy=as(tax_table(Nasal_3M1Y_pa_filt), "matrix"), prevalence=taxa_sums(Nasal_3M1Y_pa_filt)*100/(N_subj*2)) 

# difference in change
df.pa.nasal.C1$pa.change.diff <- df.pa.nasal.C1$Y_P_Change - df.pa.nasal.C1$X_P_Change
```
Aesthetic things
```{r} 
## Plot by major phylum & annotate signif taxa
df.pa.nasal.C1$Phylum <- ifelse(df.pa.nasal.C1$taxonomy.Phylum %in% Main_phyla, df.pa.nasal.C1$taxonomy.Phylum, "Other")
#Reorder the phyla 
df.pa.nasal.C1$Phylum = factor(df.pa.nasal.C1$Phylum, levels=c(Main_phyla, "Other"))
```
Plot Change in Prevalence 
```{r} 
x_lab <- paste("Colds (n=", nrow(X), ")\n1 Year - 3 Month Prevalence (%)", sep="")
y_lab <- paste("No Colds (n=", nrow(Y), ")\n1 Year - 3 Month Prevalence (%)", sep="")

Fig_Ext_N_Cold <- ggplot() + 
  geom_point(data=df.pa.nasal.C1, aes(x=X_P_Change, y=Y_P_Change, color=Phylum, size=prevalence), alpha=0.75) + 
  xlab(x_lab) + ylab(y_lab) + 
  scale_color_manual(values = cbPalette) +
  scale_y_continuous(limits=c(-37,60.1), expand = c(0,0))+
  scale_x_continuous(limits=c(-37,60.1), expand = c(0,0))+
  annotate("segment", x = -37, xend = 60, y = -37, yend = 60, colour = "red", size=0.5) + ggtitle("Nasal")
Fig_Ext_N_Cold
```

**Permutation test for Prevalence Trajectory analysis - See Permutation_Tests_PrevTrajectories directory for source code**
```{r} 
source("Permutation_Tests_PrevTrajectories/13_Colds_Nasal.R")

# Test output
# Res_per_taxa_Cold_N - p-value assigned to each taxa; p_value = later in healthy; p_value_2 = earlier in healthy
original_wilcox_Cold_N # Overall significance test
```


#### Gut, Colds 0-3 months (Not shown but used for Figure 3D)
```{r} 
X <- subset(change_3m1y_pa_G_sdf, colds_0to3m == "Yes")
Y <- subset(change_3m1y_pa_G_sdf, colds_0to3m == "No")

# Make data.frame of prevalence like before BUT keeping as proprotions instead of Percentages for now
df.pa.gut.C <- data.frame(X_P_Change=colSums(X[1:N_taxa_G])*100/dim(X)[1],Y_P_Change=colSums(Y[1:N_taxa_G])*100/dim(Y)[1], taxonomy=as(tax_table(Gut_3M1Y_pa_filt), "matrix"), prevalence=taxa_sums(Gut_3M1Y_pa_filt)*100/(N_subj_G*2))

# difference in change
df.pa.gut.C$pa.change.diff <- df.pa.gut.C$Y_P_Change - df.pa.gut.C$X_P_Change
```
Asthetic things, not important
```{r} 
## Plot by major phylum & annotate signif taxa
df.pa.gut.C$Phylum <- ifelse(df.pa.gut.C$taxonomy.Phylum %in% Main_phyla, df.pa.gut.C$taxonomy.Phylum, "Other")
#Reorder the phyla 
df.pa.gut.C$Phylum = factor(df.pa.gut.C$Phylum, levels=c(Main_phyla, "Other"))
```
Plot Change in Prevalence 
```{r} 
x_lab <- paste("Colds (n=", nrow(X), ")\n1 Year - 3 Month Prevalence (%)", sep="")
y_lab <- paste("No Colds (n=", nrow(Y), ")\n1 Year - 3 Month Prevalence (%)", sep="")

Fig_Ext_G_Cold <- ggplot() + 
  geom_point(data=df.pa.gut.C, aes(x=X_P_Change, y=Y_P_Change, color=Phylum, size=prevalence), alpha=0.75) + 
  xlab(x_lab) + ylab(y_lab) + 
  scale_color_manual(values = cbPalette) +
  scale_y_continuous(limits=c(-37,60), expand = c(0,0))+
  scale_x_continuous(limits=c(-37,60), expand = c(0,0))+
  annotate("segment", x = -37, xend = 60, y = -37, yend = 60, colour = "red", size=0.5) + ggtitle("Gut")
Fig_Ext_G_Cold
```

**Permutation test for Prevalence Trajectory analysis - See Permutation_Tests_PrevTrajectories directory for source code**
```{r} 
source("Permutation_Tests_PrevTrajectories/14_Colds_Gut.R")

# Test output
# Res_per_taxa_Cold_G - p-value assigned to each taxa; p_value = later in healthy; p_value_2 = earlier in healthy
original_wilcox_Cold_G # Overall significance test
```

### Compile & save all prevalence trajectory results
```{r}
# compile & save results for individ taxa

# saving everything to output
Per_test_df_ls <- list(Res_per_taxa_ast_N, Res_per_taxa_BF_N, Res_per_taxa_ast5y_N, 
                       Res_per_taxa_ast3y5y_N, Res_per_taxa_wheeze_N, Res_per_taxa_atopy_N, Res_per_taxa_Cold_N, 
                       Res_per_taxa_ast_G, Res_per_taxa_BF_G, Res_per_taxa_ast5y_G, Res_per_taxa_ast3y5y_G, 
                       Res_per_taxa_wheeze_G, Res_per_taxa_atopy_G, Res_per_taxa_Cold_G)
names(Per_test_df_ls) <-  c("Ast3y_Nasal", "BF_Nasal", "Ast5y_Nasal", "Ast3y_5y_Nasal", "Wheeze_Nasal", "Atopy_Nasal", "Cold_Nasal", 
                            "Ast3y_Gut", "BF_Gut", "Ast5y_Gut", "Ast3y_5y_Gut", "Wheeze_Gut", "Atopy_Gut", "Cold_Gut")

# Save as an overall rds file in Output/PermTests
saveRDS(Per_test_df_ls, "Output/PermTests/ALL_Permutation_PrevTraj_Res.rds")

# Save as individual csv files for others 
outpath_Pt1 <- "Output/PermTests/Permutation_PrevTraj_Res"
outfiles <- paste(outpath_Pt1, names(Per_test_df_ls), ".csv", sep = "_")

mapply(function(x, y) write.csv(x, file=y, row.names = FALSE, quote = FALSE), x=Per_test_df_ls, y=outfiles, SIMPLIFY = FALSE)
```


```{r, include=FALSE}
# Save prevalence trajectory scatter plots, remove axis titles and re-add later

## saving a legend (all will be the same)
legend_PT <- plot_grid(get_legend(Fig_3C_N), ncol = 1)
tiff(file = "Figures/Fig_3C_Legend_PrevTraj.tiff", width = 500, height = 1000, units = "px", res = 300) 
legend_PT
dev.off()

## Asthma
Fig_3C_N_2 <- Fig_3C_N + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank()) + ggtitle("")
tiff(file = "Figures/Fig_3C_Nasal_Asthma.tiff", width = 1275, height = 1275, units = "px", res = 300) 
Fig_3C_N_2
dev.off()

Fig_3C_G_2 <- Fig_3C_G + theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank()) + ggtitle("")
tiff(file = "Figures/Fig_3C_Gut_Asthma.tiff", width = 1275, height = 1275, units = "px", res = 300) 
Fig_3C_G_2
dev.off()

```

# Figure 3D - Heatmaps showing Taxa with Prevalence Trajectories that Differ by Asthma, compared to differences by other Phenotypes

## Nasal heatmap

Making dataframe showing p-values < 0.05 for Later colonizers as "1", Earlier colonizers as "-1"; and non-significant taxa as "0"
```{r}
Per_test_df_ls_N <- Per_test_df_ls[1:7] 

# for nasal, all dataframes have the same order / generated in the same way - so can use data.frame to merge
## Binary dataframe for Late taxa < 0.05
p_vals_Binary_N <- data.frame(row.names = row.names(Per_test_df_ls_N$Ast3y_Nasal),
                           Asthma = ifelse(Per_test_df_ls_N$Ast3y_Nasal$p_value < 0.05, 1, ifelse(Per_test_df_ls_N$Ast3y_Nasal$p_value_2 < 0.05, -1, 0)),
                           BF = ifelse(Per_test_df_ls_N$BF_Nasal$p_value < 0.05, 1, ifelse(Per_test_df_ls_N$BF_Nasal$p_value_2 < 0.05, -1, 0)),
                           Colds = ifelse(Per_test_df_ls_N$Cold_Nasal$p_value < 0.05, 1, ifelse(Per_test_df_ls_N$Cold_Nasal$p_value_2 < 0.05, -1, 0)),
                           Wheeze_no_Atopy = ifelse(Per_test_df_ls_N$Wheeze_Nasal$p_value < 0.05, 1, 
                                                    ifelse(Per_test_df_ls_N$Wheeze_Nasal$p_value_2 < 0.05, -1, 0)))

## don't like how rownames were modified - change back using ref dataset - df.pa.nasal.ast
p_vals_Binary_N2 <- merge(p_vals_Binary_N, subset(df.pa.nasal.ast, select = c("taxonomy.ASV_taxonomy")), by="row.names")
p_vals_Binary_N2$Row.names <- NULL

# Also for ComplexHeatmap, can only have names as rownames
row.names(p_vals_Binary_N2) <- p_vals_Binary_N2$taxonomy.ASV_taxonomy
p_vals_Binary_N2$taxonomy.ASV_taxonomy <- NULL
```

```{r}
# Comparing all against those taxa significant for Asthma
p_vals_Binary_N_Ast <- subset(p_vals_Binary_N2, Asthma == 1 |  Asthma == -1)

## reorder rows and transpose for heatmap
p_vals_Binary_N_Ast <- p_vals_Binary_N_Ast[order(-p_vals_Binary_N_Ast$Asthma, -p_vals_Binary_N_Ast$BF, -p_vals_Binary_N_Ast$Colds, -p_vals_Binary_N_Ast$Wheeze_no_Atopy),]

p_vals_Binary_N_Ast_t <- t(p_vals_Binary_N_Ast)

#colnames(p_vals_Binary_N_Ast_t) # may want to re-arrange column order yet
```

Heatmap showing the direction of association 
```{r, fig.width=10}
## edit some long taxa names
colnames(p_vals_Binary_N_Ast_t) <- colnames(p_vals_Binary_N_Ast_t) %>% gsub("\\ sp\\.", "", .) %>% 
                                    gsub("Unclassified Clostridia UCG\\-014 31", "Clostridia 31", .) %>% 
                                    gsub("Unclassified ", "", .)


colors2 = structure(c("skyblue1", "#b3b3b3", "#ff8a90"), names = c("1","0", "-1")) 

Fig_3D_N_h = Heatmap(p_vals_Binary_N_Ast_t, col = colors2, cluster_columns = FALSE, cluster_rows = FALSE,  
                    name = "Association", show_row_dend = FALSE,show_column_dend = FALSE, show_column_names = TRUE, 
                    show_row_names = FALSE, row_title = "", row_title_side = "right", row_title_rot = 90, 
                    row_title_gp = gpar(fontsize = 7), column_names_gp = gpar(fontsize(2))) 

# Make side annotation: showing the percent taxa that are Late with no Asthma, that are also 'late' with other factors
## of the 41 that are sig for Asthma, 36 are Late w/t no asthma - 36 is the total
Direction_sig_Asthma_L <- subset(p_vals_Binary_N_Ast, Asthma == 1)

n_ast_tax <- nrow(Direction_sig_Asthma_L)
Pct_late <- data.frame(Asthma=100, BF=table(Direction_sig_Asthma_L$BF)[3]*100/n_ast_tax,
                       Colds=table(Direction_sig_Asthma_L$Colds)[3]*100/n_ast_tax,
                       Wheeze=table(Direction_sig_Asthma_L$Wheeze)[2]*100/n_ast_tax) # asthma will always be 100% 
Pct_late <- t(Pct_late)
Pct_late # Add annotations too: 36/36, 17/36, 12/36, 17/36

ha1 = Heatmap(Pct_late, show_row_dend = FALSE, show_column_dend = FALSE, show_column_names = FALSE, show_row_names = FALSE, colorRamp2(c(0, 100), c("white", "red")))


# Side annotation = ha1
Fig_3D_N <- draw(Fig_3D_N_h + ha1, row_sub_title_side = "right")
```

## Gut Heatmap
Making dataframe showing p-values < 0.05 for Later colonizers as "1", Earlier colonizers as "-1"; and non-significant taxa as "0"
```{r}
Per_test_df_ls_G <- Per_test_df_ls[8:14]

# for nasal, all dataframes have the same order / generated in the same way - so can use data.frame to merge
## Binary dataframe for Late taxa < 0.05
p_vals_Binary_G <- data.frame(row.names = row.names(Per_test_df_ls_G$Ast3y_Gut),
                           Asthma = ifelse(Per_test_df_ls_G$Ast3y_Gut$p_value < 0.05, 1, ifelse(Per_test_df_ls_G$Ast3y_Gut$p_value_2 < 0.05, -1, 0)),
                           BF = ifelse(Per_test_df_ls_G$BF_Gut$p_value < 0.05, 1, ifelse(Per_test_df_ls_G$BF_Gut$p_value_2 < 0.05, -1, 0)),
                           Colds = ifelse(Per_test_df_ls_G$Cold_Gut$p_value < 0.05, 1, ifelse(Per_test_df_ls_G$Cold_Gut$p_value_2 < 0.05, -1, 0)),
                           Wheeze_no_Atopy = ifelse(Per_test_df_ls_G$Wheeze_Gut$p_value < 0.05, 1, 
                                                    ifelse(Per_test_df_ls_G$Wheeze_Gut$p_value_2 < 0.05, -1, 0)))

## don't like how rownames were modified - change back using ref dataset - df.pa.gut.ast
p_vals_Binary_G2 <- merge(p_vals_Binary_G, subset(df.pa.gut.ast, select = c("taxonomy.ASV_taxonomy")), by="row.names")
p_vals_Binary_G2$Row.names <- NULL

# Also for ComplexHeatmap, can only have names as rownames
row.names(p_vals_Binary_G2) <- p_vals_Binary_G2$taxonomy.ASV_taxonomy
p_vals_Binary_G2$taxonomy.ASV_taxonomy <- NULL
```

```{r}
# Comparing all against those taxa significant for Asthma
p_vals_Binary_G_Ast <- subset(p_vals_Binary_G2, Asthma == 1 |  Asthma == -1)

## reorder rows and transpose for heatmap
p_vals_Binary_G_Ast <- p_vals_Binary_G_Ast[order(-p_vals_Binary_G_Ast$Asthma, -p_vals_Binary_G_Ast$BF, -p_vals_Binary_G_Ast$Colds, -p_vals_Binary_G_Ast$Wheeze_no_Atopy),]

p_vals_Binary_G_Ast_t <- t(p_vals_Binary_G_Ast)

#colnames(p_vals_Binary_G_Ast_t) # may want to re-arrange column order yet
```

Heatmap showing the direction of association 
```{r, fig.width=10}
## edit some long taxa names
colnames(p_vals_Binary_G_Ast_t) <- colnames(p_vals_Binary_G_Ast_t) %>% gsub("\\ sp\\.", "", .) %>% 
                                   gsub("^\\[", "", .) %>% gsub("\\] ", "", .) %>% gsub("Unclassified ", "", .) %>% 
                                   gsub("Lachnospiraceae UCG-008 25", "Lachnospiraceae 25", .) %>%gsub("  ", " ", .)


colors2 = structure(c("skyblue1", "#b3b3b3", "#ff8a90"), names = c("1","0", "-1")) 

Fig_3D_G_h = Heatmap(p_vals_Binary_G_Ast_t, col = colors2, cluster_columns = FALSE, cluster_rows = FALSE,  
                    name = "Association", show_row_dend = FALSE,show_column_dend = FALSE, show_column_names = TRUE, 
                    show_row_names = FALSE, row_title = "", row_title_side = "right", row_title_rot = 90, 
                    row_title_gp = gpar(fontsize = 7), column_names_gp = gpar(fontsize(2))) 

# Make side annotation: showing the percent taxa that are Late with no Asthma, that are also 'late' with other factors
## of the 41 that are sig for Asthma, 36 are Late w/t no asthma - 36 is the total
Direction_sig_Asthma_L <- subset(p_vals_Binary_G_Ast, Asthma == 1)

n_ast_tax <- nrow(Direction_sig_Asthma_L)
Pct_late <- data.frame(Asthma=100, BF=table(Direction_sig_Asthma_L$BF)[2]*100/n_ast_tax,
                       Colds=table(Direction_sig_Asthma_L$Colds)[3]*100/n_ast_tax,
                       Wheeze=table(Direction_sig_Asthma_L$Wheeze)[2]*100/n_ast_tax) # asthma will always be 100% 
Pct_late <- t(Pct_late)
Pct_late # Add annotations too: 36/36, 17/36, 12/36, 17/36

ha1 = Heatmap(Pct_late, show_row_dend = FALSE, show_column_dend = FALSE, show_column_names = FALSE, show_row_names = FALSE, colorRamp2(c(0, 100), c("white", "red")))


# Side annotation = ha1
Fig_3D_G <- draw(Fig_3D_G_h + ha1, row_sub_title_side = "right")
```

```{r, include=FALSE}
## save
tiff(file = "Figures/Fig_3D_Nasal_heatmap.tiff", width = 2200, height = 1200, units = "px", res = 300) 
Fig_3D_N
dev.off()

tiff(file = "Figures/Fig_3D_Gut_heatmap.tiff", width = 2200, height = 1200, units = "px", res = 300) 
Fig_3D_G
dev.off()
```

